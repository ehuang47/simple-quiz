<!DOCTYPE html>
<html>

<head>
  <link rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/css/bootstrap.min.css"
    integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T"
    crossorigin="anonymous">
  <style>
    body {
      margin: 20px;
    }

    * {
      text-align: center;
    }

    div.choice:hover {
      background-color: cadetblue;
    }
  </style>
</head>

<body>
  <h2>{{title}} Quiz</h2>
  <h3>Time Remaining: 15:00</h3>
  <hr>
  <form>
    <ol>
      {{#each questions}}
        <li>
          <div>{{this.question}}</div>
          {{#each this.choices}}
            <div class="choice">
              <input type="radio" name="{{../question}}" value="{{this}}"> {{this}}
            </div>
          {{/each}}
        </li>
      {{/each}}
    </ol>
    <input type="submit" id="submit">
  </form>
</body>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script>
  const log = console.log;

  document.forms[0].addEventListener('click', e => {
    if (e.target.getAttribute("class") === "choice") e.target.firstElementChild.checked = true;
  });

  let start = new Date().toLocaleString();
  let timeLeft = 1000 * 60 * 15; // 15 minutes
  // let timeLeft = 1000 * 5; // 5 sec

  const countdown = function () {
    timeLeft -= 1000;
    const timer = document.body.firstElementChild.nextElementSibling;
    const min = String(Math.floor(timeLeft / 60 / 1000)).padStart(2, '0');
    const sec = min == '00' ?
      String(Math.floor((timeLeft / 1000))).padStart(2, '0') :
      String(Math.floor((timeLeft / 1000) % (min * 60))).padStart(2, '0');
    timer.innerText = `Time Remaining: ${min}:${sec}`;
    // log(timeLeft, min, sec);
    if (timeLeft <= 0) {
      alert("Time's up! Your quiz will be submitted.");
      document.getElementById("submit").click();
      clearInterval(interval);
    }
  };
  const interval = setInterval(countdown, 1000);

  const submitBtn = document.getElementById('submit');
  submitBtn.addEventListener('click', function (e) {
    e.preventDefault();

    const inputs = Array.from(document.forms[0].elements);
    const selections = [];
    // loop 4 inputs at a time, and alert if one was left unchecked

    for (let i = 0; i < 40; i += 4) {
      let selectedAnswer = false;
      for (let j = 0; j < 4; j++) {
        const option = inputs[i + j];
        if (option.checked) {
          selections.push(option.value);
          selectedAnswer = true;
        }
      }
      if (!selectedAnswer) selections.push('');
    }

    let end = new Date().toLocaleString();
    $.ajax({
      url: "/quiz",
      type: "POST",
      contentType: "application/json; charset=utf-8",
      data: JSON.stringify({ selections, start, end }),
      success: function (data, textStatus, req) {
        log(data);
        window.location = data.redirect;
      },
      error: function (res) {
        alert(res.responseJSON.errorMsg);
      }
    });


  });
</script>

</html>